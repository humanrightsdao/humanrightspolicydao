// src/hooks/useUserInfo.js
import { useState, useEffect, useCallback } from "react";
import { supabase } from "../lib/supabase";
import { useTranslation } from "react-i18next";

export default function useUserInfo() {
  const { t } = useTranslation();
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ñƒ ÑÐ¾Ñ†Ñ–Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½ÑŒ
  const parseSocialLinks = useCallback((links) => {
    console.log(
      "ðŸš€ parseSocialLinks called with:",
      links,
      "Type:",
      typeof links,
    );

    // Ð¯ÐºÑ‰Ð¾ null Ð°Ð±Ð¾ undefined
    if (links == null) {
      console.log("ðŸ“ Links is null/undefined, returning empty array");
      return [];
    }

    // Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ Ð²Ð¶Ðµ Ð¼Ð°ÑÐ¸Ð²
    if (Array.isArray(links)) {
      console.log("âœ… Links is already an array:", links);
      return links;
    }

    // Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ°
    if (typeof links === "string") {
      try {
        // Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ð·Ð°Ð¹Ð²Ñ– Ð¿Ñ€Ð¾Ð±Ñ–Ð»Ð¸
        const trimmed = links.trim();
        console.log("ðŸ” Trimmed string:", trimmed);

        // Ð¯ÐºÑ‰Ð¾ Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð°Ð±Ð¾ Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ–Ð¹ Ð¼Ð°ÑÐ¸Ð² JSON
        if (
          trimmed === "" ||
          trimmed === "[]" ||
          trimmed === "{}" ||
          trimmed === "null"
        ) {
          console.log("ðŸ“„ Empty string/array, returning empty array");
          return [];
        }

        // Ð¡Ð¿Ñ€Ð¾Ð±Ð° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ñƒ JSON
        let parsed;
        try {
          parsed = JSON.parse(trimmed);
          console.log("âœ… Successfully parsed JSON:", parsed);
        } catch (parseError) {
          console.error("âŒ JSON parse error:", parseError);
          return [];
        }

        if (Array.isArray(parsed)) {
          return parsed;
        }

        // Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ Ð¾Ð±'Ñ”ÐºÑ‚, Ð°Ð»Ðµ Ð½Ðµ Ð¼Ð°ÑÐ¸Ð²
        if (parsed && typeof parsed === "object") {
          console.log("ðŸ”„ Parsed result is object, converting to array");
          return Object.entries(parsed).map(([key, value]) => ({
            platform: key,
            username: value,
            url: `https://${key.toLowerCase()}.com/${value}`,
          }));
        }

        return [];
      } catch (e) {
        console.error("âŒ Error parsing social links:", e);
        return [];
      }
    }

    // Ð”Ð»Ñ Ð±ÑƒÐ´ÑŒ-ÑÐºÐ¾Ð³Ð¾ Ñ–Ð½ÑˆÐ¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ñƒ
    console.log("â“ Unknown links type, returning empty array");
    return [];
  }, []);

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— Ð¿Ñ€Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
  const loadUserInfo = useCallback(async () => {
    console.log("ðŸ”„ loadUserInfo started");
    setLoading(true);
    setError("");

    try {
      // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–ÑŽ
      const {
        data: { user },
        error: userError,
      } = await supabase.auth.getUser();

      if (userError) {
        throw new Error(t("user_error") || "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°");
      }

      if (!user) {
        console.log("ðŸ‘¤ No user found");
        setUserInfo(null);
        setLoading(false);
        return;
      }

      console.log("ðŸ‘¤ User ID:", user.id);
      console.log("ðŸ‘¤ User email:", user.email);

      // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ Ð· Ð±Ð°Ð·Ð¸ Ð´Ð°Ð½Ð¸Ñ…
      const { data: profile, error: profileError } = await supabase
        .from("users")
        .select("*")
        .eq("id", user.id)
        .single();

      console.log("ðŸ“Š Profile from DB:", profile);

      if (profileError) {
        console.warn("âš ï¸ Profile not found, creating new one");
        // Ð¯ÐºÑ‰Ð¾ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ Ð½ÐµÐ¼Ð°Ñ”, ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð±Ð°Ð·Ð¾Ð²Ð¸Ð¹
        const { data: newProfile, error: createError } = await supabase
          .from("users")
          .insert({
            id: user.id,
            email: user.email,
            unique_name:
              user.user_metadata?.unique_name || `user_${user.id.slice(0, 8)}`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            has_completed_onboarding: false,
            social_links: "[]",
            role: "user", // Ð—Ð° Ð·Ð°Ð¼Ð¾Ð²Ñ‡ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¸Ð¹ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡
          })
          .select()
          .single();

        if (createError) {
          throw new Error(
            t("create_profile_error") || "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ",
          );
        }

        const userData = {
          id: newProfile.id,
          email: newProfile.email,
          uniqueName: newProfile.unique_name,
          country: newProfile.country || "EARTH",
          walletAddress: newProfile.wallet_address || null,
          dateOfBirth: newProfile.date_of_birth || null,
          age: calculateAge(newProfile.date_of_birth),
          bio: newProfile.bio || null,
          socialLinks: parseSocialLinks(newProfile.social_links),
          avatarUrl: newProfile.avatar_url || null,
          hasAcceptedTerms: newProfile.has_accepted_terms || false,
          hasCompletedOnboarding: newProfile.has_completed_onboarding || false,
          emailConfirmedAt: newProfile.email_confirmed_at || null,
          hasAcceptedHumanRightsPolicy:
            newProfile.has_accepted_human_rights_policy || false,
          hasCompletedLessons: newProfile.has_completed_lessons || false,
          hasCompletedTests: newProfile.has_completed_tests || false,
          createdAt: newProfile.created_at,
          updatedAt: newProfile.updated_at,
          role: newProfile.role || "user", // Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ñ€Ð¾Ð»ÑŒ
        };

        console.log("âœ… Created new user data:", userData);
        setUserInfo(userData);
        return userData;
      }

      // Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð²Ð°Ð½Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
      const socialLinks = parseSocialLinks(profile.social_links);

      const userData = {
        id: profile.id,
        email: profile.email,
        uniqueName: profile.unique_name,
        country: profile.country || "EARTH",
        walletAddress: profile.wallet_address || null,
        dateOfBirth: profile.date_of_birth || null,
        age: calculateAge(profile.date_of_birth),
        bio: profile.bio || null,
        socialLinks: socialLinks,
        avatarUrl: profile.avatar_url || null,
        hasAcceptedTerms: profile.has_accepted_terms || false,
        hasCompletedOnboarding: profile.has_completed_onboarding || false,
        emailConfirmedAt: profile.email_confirmed_at || null,
        hasAcceptedHumanRightsPolicy:
          profile.has_accepted_human_rights_policy || false,
        hasCompletedLessons: profile.has_completed_lessons || false,
        hasCompletedTests: profile.has_completed_tests || false,
        createdAt: profile.created_at,
        updatedAt: profile.updated_at,
        role: profile.role || "user", // Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ñ€Ð¾Ð»ÑŒ
      };

      console.log("âœ… Parsed user data:", {
        avatarUrl: userData.avatarUrl,
        socialLinks: userData.socialLinks,
        socialLinksCount: userData.socialLinks.length,
        hasAvatar: !!userData.avatarUrl,
        role: userData.role, // Ð›Ð¾Ð³ÑƒÑ”Ð¼Ð¾ Ñ€Ð¾Ð»ÑŒ
      });

      // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð½Ð°ÑÐ²Ð½Ñ–ÑÑ‚ÑŒ Web3 Ð°Ð´Ñ€ÐµÑÐ¸ Ð² localStorage
      const web3Addr = localStorage.getItem("web3_wallet_address");
      if (web3Addr && !userData.walletAddress) {
        userData.walletAddress = web3Addr;
      }

      setUserInfo(userData);
      return userData;
    } catch (error) {
      console.error("âŒ Error loading profile:", error.message || error);
      setError(error.message);
      return null;
    } finally {
      setLoading(false);
      console.log("ðŸ loadUserInfo completed");
    }
  }, [t, parseSocialLinks]);

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— Ð¿Ñ€Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
  const updateUserInfo = useCallback(
    async (updates) => {
      try {
        console.log("ðŸ”„ updateUserInfo called with:", updates);

        const {
          data: { user },
        } = await supabase.auth.getUser();

        if (!user) {
          throw new Error(
            t("user_not_authenticated") || "ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹",
          );
        }

        // ÐŸÑ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð°Ð½Ð¸Ñ… Ð´Ð»Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
        const updateData = {
          updated_at: new Date().toISOString(),
        };

        // Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð¿Ð¾Ð»Ñ, ÑÐºÑ– Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð¾Ð½Ð¾Ð²Ð¸Ñ‚Ð¸
        if (updates.unique_name !== undefined) {
          updateData.unique_name = updates.unique_name;
        }
        if (updates.bio !== undefined) {
          updateData.bio = updates.bio;
        }
        if (updates.country !== undefined) {
          updateData.country = updates.country;
        }
        if (updates.date_of_birth !== undefined) {
          updateData.date_of_birth = updates.date_of_birth;
        }
        if (updates.avatar_url !== undefined) {
          updateData.avatar_url = updates.avatar_url;
        }
        if (updates.role !== undefined) {
          // Ð”Ð¾Ð´Ð°Ð½Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ€Ð¾Ð»Ñ–
          updateData.role = updates.role;
        }

        // ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° ÑÐ¾Ñ†Ñ–Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½ÑŒ
        if (updates.socialLinks !== undefined) {
          const linksToSave = Array.isArray(updates.socialLinks)
            ? updates.socialLinks
            : [];
          updateData.social_links = linksToSave;
          console.log("ðŸ’¾ Saving social links:", linksToSave);
        }

        if (updates.social_links !== undefined) {
          const linksToSave = Array.isArray(updates.social_links)
            ? updates.social_links
            : [];
          updateData.social_links = linksToSave;
          console.log("ðŸ’¾ Saving social links (alt):", linksToSave);
        }

        console.log("ðŸ“¤ Updating user with data:", updateData);

        const { data, error: updateError } = await supabase
          .from("users")
          .update(updateData)
          .eq("id", user.id)
          .select()
          .single();

        if (updateError) {
          console.error("âŒ Update error:", updateError);
          throw new Error(updateError.message);
        }

        console.log("âœ… User updated successfully:", data);

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¸Ð¹ ÑÑ‚Ð°Ð½
        const updatedUserInfo = {
          ...userInfo,
          updatedAt: updateData.updated_at,
        };

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ ÑÐ¿ÐµÑ†Ð¸Ñ„Ñ–Ñ‡Ð½Ñ– Ð¿Ð¾Ð»Ñ
        if (updates.unique_name !== undefined) {
          updatedUserInfo.uniqueName = updates.unique_name;
        }
        if (updates.bio !== undefined) {
          updatedUserInfo.bio = updates.bio;
        }
        if (updates.country !== undefined) {
          updatedUserInfo.country = updates.country;
        }
        if (updates.date_of_birth !== undefined) {
          updatedUserInfo.dateOfBirth = updates.date_of_birth;
          updatedUserInfo.age = calculateAge(updates.date_of_birth);
        }
        if (updates.avatar_url !== undefined) {
          updatedUserInfo.avatarUrl = updates.avatar_url;
        }
        if (updates.role !== undefined) {
          // Ð”Ð¾Ð´Ð°Ð½Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ€Ð¾Ð»Ñ–
          updatedUserInfo.role = updates.role;
        }

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ ÑÐ¾Ñ†Ñ–Ð°Ð»ÑŒÐ½Ñ– Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ
        if (updates.socialLinks !== undefined) {
          updatedUserInfo.socialLinks = Array.isArray(updates.socialLinks)
            ? updates.socialLinks
            : [];
        }
        if (updates.social_links !== undefined) {
          updatedUserInfo.socialLinks = Array.isArray(updates.social_links)
            ? updates.social_links
            : [];
        }

        console.log("âœ… Updated local user info:", updatedUserInfo);
        setUserInfo(updatedUserInfo);
        return updatedUserInfo;
      } catch (error) {
        console.error(
          t("update_profile_error") || "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ",
          error,
        );
        throw error;
      }
    },
    [userInfo, t],
  );

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¸
  const uploadAvatar = useCallback(
    async (file) => {
      try {
        console.log(
          "ðŸ”„ uploadAvatar called with file:",
          file.name,
          file.type,
          file.size,
        );

        const {
          data: { user },
        } = await supabase.auth.getUser();

        if (!user) {
          throw new Error(
            t("user_not_authenticated") || "ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹",
          );
        }

        // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ñƒ
        if (!file.type.startsWith("image/")) {
          throw new Error(
            t("avatar_file_type_error") || "Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð²Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ",
          );
        }

        // Ð”Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ñ– Ñ‚Ð¸Ð¿Ð¸ Ñ„Ð°Ð¹Ð»Ñ–Ð²
        const allowedTypes = [
          "image/jpeg",
          "image/png",
          "image/webp",
          "image/gif",
        ];
        if (!allowedTypes.includes(file.type)) {
          throw new Error(
            t("avatar_file_format_error") ||
              "Ð”Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ñ– Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸: JPG, PNG, WebP, GIF",
          );
        }

        // ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€ 5MB
        if (file.size > 5 * 1024 * 1024) {
          throw new Error(
            t("avatar_file_size_error") ||
              "Ð Ð¾Ð·Ð¼Ñ–Ñ€ Ñ„Ð°Ð¹Ð»Ñƒ Ð½Ðµ Ð¿Ð¾Ð²Ð¸Ð½ÐµÐ½ Ð¿ÐµÑ€ÐµÐ²Ð¸Ñ‰ÑƒÐ²Ð°Ñ‚Ð¸ 5MB",
          );
        }

        // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð´Ð»Ñ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ ÑÑ‚Ð°Ñ€Ð¾Ñ— Ð²ÐµÑ€ÑÑ–Ñ—
        const currentAvatarUrl = userInfo?.avatarUrl;
        if (currentAvatarUrl) {
          try {
            const oldFileName = currentAvatarUrl.split("/").pop();
            console.log("ðŸ—‘ï¸ Deleting old avatar:", oldFileName);
            await supabase.storage
              .from("user-content")
              .remove([`avatars/${user.id}/${oldFileName}`]);
          } catch (deleteError) {
            console.warn("âš ï¸ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ ÑÑ‚Ð°Ñ€Ð¸Ð¹ Ð°Ð²Ð°Ñ‚Ð°Ñ€:", deleteError);
          }
        }

        // Ð“ÐµÐ½ÐµÑ€ÑƒÑ”Ð¼Ð¾ ÑƒÐ½Ñ–ÐºÐ°Ð»ÑŒÐ½Ðµ Ñ–Ð¼'Ñ Ñ„Ð°Ð¹Ð»Ñƒ
        const fileExt = file.name.split(".").pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
        const filePath = `avatars/${user.id}/${fileName}`;

        console.log("ðŸ“¤ Uploading avatar to:", filePath);

        // Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ Ñ„Ð°Ð¹Ð» Ð² Supabase Storage
        const { error: uploadError } = await supabase.storage
          .from("user-content")
          .upload(filePath, file, {
            cacheControl: "3600",
            upsert: true,
            contentType: file.type,
          });

        if (uploadError) {
          console.error("âŒ Upload error:", uploadError);
          throw new Error(uploadError.message);
        }

        // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿ÑƒÐ±Ð»Ñ–Ñ‡Ð½Ð¸Ð¹ URL Ð· Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ð¸Ð¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð¼ Ð´Ð»Ñ ÐºÐµÑˆÑƒÐ²Ð°Ð½Ð½Ñ
        const {
          data: { publicUrl },
        } = supabase.storage.from("user-content").getPublicUrl(filePath, {
          download: false,
        });

        // Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ timestamp Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð±Ñ–Ð³Ð°Ð½Ð½Ñ ÐºÐµÑˆÑƒÐ²Ð°Ð½Ð½ÑŽ
        const urlWithTimestamp = `${publicUrl}?t=${Date.now()}`;

        console.log("âœ… Avatar uploaded, public URL:", urlWithTimestamp);

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ð· Ð½Ð¾Ð²Ð¾ÑŽ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¾ÑŽ
        const { error: updateError } = await supabase
          .from("users")
          .update({
            avatar_url: urlWithTimestamp,
            updated_at: new Date().toISOString(),
          })
          .eq("id", user.id);

        if (updateError) {
          console.error("âŒ Profile update error:", updateError);
          throw new Error(updateError.message);
        }

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¸Ð¹ ÑÑ‚Ð°Ð½
        setUserInfo((prev) => ({
          ...prev,
          avatarUrl: urlWithTimestamp,
          updatedAt: new Date().toISOString(),
        }));

        console.log("âœ… Avatar updated in state");
        return urlWithTimestamp;
      } catch (error) {
        console.error("âŒ Avatar upload error:", error.message || error);
        throw error;
      }
    },
    [userInfo, t],
  );

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¸
  const deleteAvatar = useCallback(async () => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) {
        throw new Error(
          t("user_not_authenticated") || "ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹",
        );
      }

      // Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ñ„Ð°Ð¹Ð» Ð·Ñ– ÑÑ…Ð¾Ð²Ð¸Ñ‰Ð°
      const currentAvatarUrl = userInfo?.avatarUrl;
      if (currentAvatarUrl) {
        try {
          const fileName = currentAvatarUrl.split("/").pop();
          await supabase.storage
            .from("user-content")
            .remove([`avatars/${user.id}/${fileName}`]);
        } catch (deleteError) {
          console.warn("âš ï¸ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ Ñ„Ð°Ð¹Ð» Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°:", deleteError);
        }
      }

      // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° (Ð²Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ avatar_url)
      const { error: updateError } = await supabase
        .from("users")
        .update({
          avatar_url: null,
          updated_at: new Date().toISOString(),
        })
        .eq("id", user.id);

      if (updateError) {
        throw new Error(updateError.message);
      }

      // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¸Ð¹ ÑÑ‚Ð°Ð½
      setUserInfo((prev) => ({
        ...prev,
        avatarUrl: null,
        updatedAt: new Date().toISOString(),
      }));

      return true;
    } catch (error) {
      console.error(
        t("avatar_delete_error") || "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¸",
        error,
      );
      throw error;
    }
  }, [userInfo, t]);

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ
  const updateUserField = useCallback(
    async (field, value) => {
      return await updateUserInfo({ [field]: value });
    },
    [updateUserInfo],
  );

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð°Ð´Ñ€ÐµÑÐ¸ Ð³Ð°Ð¼Ð°Ð½Ñ†Ñ
  const formatWalletAddress = useCallback(
    (address, startChars = 6, endChars = 4) => {
      if (!address) return "";
      if (address.length <= startChars + endChars) return address;
      return `${address.slice(0, startChars)}...${address.slice(-endChars)}`;
    },
    [],
  );

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð²Ñ–ÐºÑƒ Ð· Ð´Ð°Ñ‚Ð¸ Ð½Ð°Ñ€Ð¾Ð´Ð¶ÐµÐ½Ð½Ñ
  function calculateAge(dateOfBirth) {
    if (!dateOfBirth) return null;

    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birthDate.getDate())
    ) {
      age--;
    }

    return age;
  }

  // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð° (Ð· fallback Ð½Ð° Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ð»Ð¸)
  const getAvatar = useCallback(() => {
    if (userInfo?.avatarUrl) {
      return userInfo.avatarUrl;
    }
    return null;
  }, [userInfo]);

  // Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¸ Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ—
  useEffect(() => {
    console.log("ðŸŽ¯ useUserInfo useEffect triggered");
    loadUserInfo();
  }, [loadUserInfo]);

  return {
    // ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð´Ð°Ð½Ñ–
    userInfo,
    loading,
    error,

    // ÐœÐµÑ‚Ð¾Ð´Ð¸ Ð´Ð»Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð· Ð´Ð°Ð½Ð¸Ð¼Ð¸
    loadUserInfo,
    updateUserInfo,
    updateUserField,
    uploadAvatar,
    deleteAvatar,
    formatWalletAddress,

    // Ð£Ñ‚Ð¸Ð»Ñ–Ñ‚Ð½Ñ– Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ—
    calculateAge,

    // Ð¨Ð²Ð¸Ð´ÐºÐ¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¸Ñ… Ð¿Ð¾Ð»Ñ–Ð²
    getEmail: () => userInfo?.email || "",
    getUniqueName: () => userInfo?.uniqueName || "",
    getCountry: () => userInfo?.country || "EARTH",
    getWalletAddress: () => userInfo?.walletAddress || "",
    getDateOfBirth: () => userInfo?.dateOfBirth || null,
    getAge: () => userInfo?.age || null,
    getSocialLinks: () => userInfo?.socialLinks || [],
    getAvatarUrl: () => userInfo?.avatarUrl || null,
    getAvatar: getAvatar,

    // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ ÑÑ‚Ð°Ð½Ñ–Ð²
    isAuthenticated: !!userInfo,
    hasWallet: !!userInfo?.walletAddress,
    hasAvatar: !!userInfo?.avatarUrl,
    // Ð”ÐžÐ”ÐÐ™Ð¢Ð• Ð¦Ð† ÐœÐ•Ð¢ÐžÐ”Ð˜ â†“
    getRole: () => userInfo?.role || "user",
    isAdmin: () => userInfo?.role === "admin",
    isModerator: () =>
      userInfo?.role === "moderator" || userInfo?.role === "admin",
  };
}